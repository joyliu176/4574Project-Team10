WITH CleanedOrders AS (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY ORDER_ID ORDER BY ORDER_DATE_TS ASC) AS rn
    FROM {{ ref('base_web_schema__orders') }}
)
SELECT 
    o.ORDER_ID,
    o.CLIENT_NAME,
    o.PAYMENT_METHOD,
    o.PAYMENT_INFO,
    o.ORDER_DATE_TS,
    o.STATE,
    o.SHIPPING_ADDRESS,
    o.SHIPPING_COST,
    o.TAX_RATE,
    COUNT(DISTINCT iv.ITEM_NAME) AS TOTAL_ITEMS,
    SUM(iv.PRICE_PER_UNIT * iv.ADD_TO_CART_QUANTITY) AS TOTAL_ORDER_VALUE,
    SUM(iv.ADD_TO_CART_QUANTITY) AS TOTAL_UNITS
FROM 
    CleanedOrders o
LEFT JOIN {{ ref('base_web_schema__item_views') }} iv ON o.SESSION_ID = iv.SESSION_ID
WHERE 
    o.rn = 1
GROUP BY
    o.ORDER_ID, o.CLIENT_NAME, o.PAYMENT_METHOD, o.PAYMENT_INFO, o.ORDER_DATE_TS, 
    o.STATE, o.SHIPPING_ADDRESS, o.SHIPPING_COST, o.TAX_RATE